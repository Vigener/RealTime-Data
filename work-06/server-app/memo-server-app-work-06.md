## 実装方針の概要


### 1. データ管理戦略

**メタデータの管理方法**
- **CSV読み込み + メモリ保持**を推奨
- 理由：
  - データベースオーバーヘッドが不要（5000件程度の規模）
  - 高速アクセス（100ms間隔の処理に適している）
  - 実装の簡素化

**データ構造設計**
```
StockMetadata: Map<Integer, StockInfo>
ShareholderMetadata: Map<Integer, ShareholderInfo>
PortfolioManager: Map<Integer, Portfolio> // 株主ID -> ポートフォリオ
TransactionHistory: List<Transaction> // 時系列保持
```

### 2. WebSocket通信戦略

**イベント駆動型アーキテクチャ**を採用：

**定期送信データ（100ms間隔）**
- 全体統計情報（男女割合、年代別統計等）
- 最新取引履歴（直近N件）
- リアルタイム更新が必要な集計データ

**リクエスト応答型データ**
- 特定株主のポートフォリオ詳細
- 地域別詳細データ
- 特定条件でのフィルタリング結果

### 3. アーキテクチャ設計

```
StockProcessor (メインエンジン)
├── MetadataManager (メタデータ管理)
├── PortfolioCalculator (ポートフォリオ計算)
├── StatisticsEngine (統計計算)
├── WebSocketServer (Web通信)
└── RequestHandler (リクエスト処理)
```

### 4. 具体的な実装ステップ

**Phase 1: 基盤構築**
1. メタデータ読み込み機能
2. ポートフォリオ管理システム
3. WebSocketサーバー構築

**Phase 2: リアルタイム処理**
1. 取引データからポートフォリオ更新
2. 統計情報の計算
3. 定期送信データの生成

**Phase 3: インタラクティブ機能**
1. 株主選択時のポートフォリオ詳細送信
2. 地域選択時のデータフィルタリング
3. 動的グラフデータ生成

### 5. データフロー設計

**リアルタイムフロー**
```
Transaction受信 → ポートフォリオ更新 → 統計計算 → WebSocket送信
```

**リクエストフロー**
```
Webからリクエスト → データフィルタリング → 計算実行 → 結果送信
```

### 6. 気になる点への回答

**メタデータ管理について**
- **CSV読み込み + メモリ保持**が最適
- 理由：データサイズが小さく、高速アクセスが重要

**WebSocket送信戦略について**
- **ハイブリッド方式**を推奨：
  - **定期送信**: 全体統計、リアルタイム指標
  - **オンデマンド送信**: 詳細データ、個別分析
- 利点：
  - 帯域幅の効率化
  - Web側の処理負荷軽減
  - スケーラビリティの確保

**送信頻度について**
- **100ms定期送信**: 軽量な全体統計
- **1s集約送信**: 重い計算結果
- **リクエスト応答**: 詳細データ

### 7. パフォーマンス考慮事項

**計算最適化**
- 増分計算の活用
- キャッシュ機能の実装
- 並列処理の活用

**メモリ管理**
- 取引履歴の適切な保持期間
- 不要データの定期クリーンアップ

この方針により、リアルタイム性とインタラクティブ性を両立した効率的なシステムが構築できます。

## 実装のポイント

- 現在はストリームが来た順に実行している
- TransactionsとStockPriceのタイムスタンプ順の並び替えの部分をレポートでうまく書くと高く評価したいそう（理想的に実装できるに越したことはない、時間の関係で簡略化することもやむを得ないが、）
- 理由としては2つのストリームもしくは2つのスレッドの動きがどちらかが遅れてしまったりすることがあるため、取引履歴ごとに現在の株価格を付与する際のcurrentStockPriceが正しい参考すべき価格かわからない。価格変動をタイムスタンプごとに保存してもよいが、